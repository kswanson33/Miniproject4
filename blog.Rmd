---
title: "Code goes here"
author: "Kendra Swanson, Margaret Perry"
date: "April 30, 2017"
output: html_document
---

```{r, message = FALSE}
library(tidyverse)
library(macleish)
library(rvest)
library(rgdal)
library(rgeos)
```

```{r, message = FALSE}
##Getting trail data
url1 <- "http://www.mass.gov/anf/research-and-tech/it-serv-and-support/application-serv/office-of-geographic-information-massgis/datalayers/dcrtrails.html"
download.file(url1, destfile = basename(url1))
unzip("dcrtrails.zip", exdir = "dcrtrails")
```

```{r, message = FALSE}
trails <- path.expand("dcrtrails")
#ogrListLayers(trails)
```

```{r, message = FALSE}
dcr_trails <- readOGR(trails, "DCR_ROADS_TRAILS_ARC")
#summary(dcr_trails)
```

```{r, message = FALSE}
##Getting college data
url_colleges<- "http://www.mass.gov/anf/research-and-tech/it-serv-and-support/application-serv/office-of-geographic-information-massgis/datalayers/colleges.html"
download.file(url_colleges, destfile = basename(url_colleges))
unzip("colleges.zip", exdir = "colleges")
```

```{r, message = FALSE}
colleges <- path.expand("colleges")
#ogrListLayers(colleges)
```

```{r, message = FALSE}
colleges_loc<- readOGR(colleges, "COLLEGES_PT")
#summary(colleges_loc)
```

```{r, message = FALSE}
##Getting contour data
url_contour <- "http://www.mass.gov/anf/research-and-tech/it-serv-and-support/application-serv/office-of-geographic-information-massgis/datalayers/hp250k.html"
download.file(url_contour, destfile = basename(url_contour))
unzip("contours250k.zip", exdir = "contours")
```

```{r, message = FALSE}
contours <- path.expand("contours")
#ogrListLayers(contours)
```

```{r, message = FALSE}
contour_mass<- readOGR(contours, "CONTOURS250K_ARC")
#summary(contour_mass)
```

```{r, message = FALSE}
##Transforming to coordinates that work in leaflet
dcr_trails <- spTransform(dcr_trails, CRS("+init=epsg:4326"))
contour_mass <- spTransform(contour_mass, CRS("+init=epsg:4326"))
colleges_loc <- spTransform(colleges_loc, CRS("+init=epsg:4326"))
```

```{r}
boundary <- spTransform(macleish_layers[["boundary"]], CRS("+init=epsg:4326"))
```

```{r, message = FALSE}
# Making a boundary polygon to use to subset contour data
library(sp)
coords <- rbind(c(42.458299, -72.710239),
                c(42.457476, -72.605017),
                c(42.316596, -72.601298),
                c(42.312746, -72.709123),
                c(42.458299, -72.710239)) %>%
  as.data.frame() %>%
  rename(lat = V1, lon = V2)
```

```{r, message = FALSE}
polygon <- coords %>%
  select(lon,lat) %>%
  Polygon()
```

```{r, message = FALSE}
sp_polygon <- SpatialPolygons(list(Polygons(list(polygon), ID = "a")))
```

```{r, message = FALSE}
proj4string(sp_polygon) <- CRS("+init=epsg:4326")
```

```{r}
# Subsetting contour data
contours_relevant <- gIntersection(sp_polygon, contour_mass)
```


Plan: 
-build a bunch of paths
-find elevation data
-pick easiest one and hardest one
```{r}
# Creating a possible trail from Smith to Macleish
trail1_df <- rbind(c(42.320327, -72.640085),
                   c(42.324335, -72.648490),
                   c(42.331041, -72.652168),
                   c(42.334372, -72.653767),
                   c(42.335918, -72.664951),
                   c(42.336029, -72.669157),
                   c(42.337021, -72.672037),
                   c(42.349495, -72.670876),
                   c(42.355109, -72.673752),
                   c(42.360215, -72.671177),
                   c(42.362339, -72.671778),
                   c(42.367444, -72.670447),
                   c(42.369632, -72.674310),
                   c(42.373473, -72.675938),
                   c(42.376707, -72.674908),
                   c(42.381684, -72.676797),
                   c(42.383206, -72.679286),
                   c(42.386528, -72.679240),
                   c(42.394298, -72.676992),
                   c(42.399369, -72.677894),
                   c(42.408527, -72.669718),
                   c(42.410903, -72.668946),
                   c(42.412941, -72.667748),
                   c(42.415080, -72.668070),
                   c(42.416474, -72.667812),
                   c(42.422388, -72.669537),
                   c(42.423410, -72.671167),
                   c(42.424194, -72.671200),
                   c(42.426677, -72.668810),
                   c(42.429433, -72.669197),
                   c(42.430898, -72.670280),
                   c(42.431642, -72.672415),
                   c(42.432109, -72.677662),
                   c(42.436971, -72.679475),
                   c(42.438159, -72.681374),
                   c(42.439378, -72.681256),
                   c(42.442229, -72.681846),
                   c(42.444493, -72.680848),
                   c(42.447509, -72.680773)) %>%
  as.data.frame() %>%
  rename(lat = V1, lon = V2)
```


```{r}
# Function to convert df of coordinates to spatial lines df
df_to_sp <- function(trail_df) {
  trail_df %>%
    select(lon, lat) %>%
    Line() %>%
    list() %>%
    Lines(ID = "a") %>%
    list() %>%
    SpatialLines()
}
```

```{r}
trail1_sp <- df_to_sp(trail1_df)
```

```{r}
# Projecting trail 1
proj4string(trail1_sp) <- CRS("+init=epsg:4326")
```

```{r}
# Finding where trail crosses contour lines
trail1_elevation <- gIntersection(trail1_sp, contour_mass)
```

```{r}
# Model for final map
mac_pal <- colorBin(palette = "Reds", domain = boundary$Shape_Leng)

leaflet() %>%
  addTiles() %>%
  addCircleMarkers(data = trail1_elevation, radius = 4, stroke = FALSE, fillOpacity = 1) %>%
  addPolylines(data = trail1_sp, opacity = .5) %>%
  addPolylines(data = contours_relevant, weight = .5) %>%
  addPolygons(data = boundary, color = ~mac_pal(Shape_Leng), weight = 1.5, opacity = .8)
```

